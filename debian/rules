#!/usr/bin/make -f

DEB_HOST_ARCH ?=$(shell dpkg-architecture -qDEB_HOST_ARCH)

CFLAGS =-O2 -Wall
LDFLAGS =-s -Os -pipe
CC =diet -v -Os gcc
STRIP =strip

ifneq ($(DEB_HOST_ARCH),alpha)
ifneq ($(DEB_HOST_ARCH),arm)
ifneq ($(DEB_HOST_ARCH),hppa)
ifneq ($(DEB_HOST_ARCH),i386)
ifneq ($(DEB_HOST_ARCH),ia64)
ifneq ($(DEB_HOST_ARCH),mips)
ifneq ($(DEB_HOST_ARCH),mipsel)
ifneq ($(DEB_HOST_ARCH),powerpc)
ifneq ($(DEB_HOST_ARCH),s390)
ifneq ($(DEB_HOST_ARCH),sparc)
  CC =gcc
endif
endif
endif
endif
endif
endif
endif
endif
endif
endif

ifneq (,$(findstring debug,$(DEB_BUILD_OPTIONS)))
  CFLAGS +=-g
endif
ifneq (,$(findstring nostrip,$(DEB_BUILD_OPTIONS)))
  STRIP =: nostrip
endif

DIR =`pwd`/debian/runit

build: deb-checkdir build-stamp
build-stamp:
	-gcc -v
	tar xfzp runit-1.0.2.tar.gz
	ln -s runit-1.0.2 admin/runit
	echo "$(CC) $(CFLAGS)" >admin/runit/src/conf-cc
	echo "$(CC) $(LDFLAGS)" >admin/runit/src/conf-ld
	$(MAKE) -Cadmin/runit/src default check
	touch build-stamp

clean: deb-checkdir deb-checkuid
	rm -rf admin
	rm -f build-stamp
	rm -rf "$(DIR)"
	rm -f debian/files debian/substvars changelog

install: deb-checkdir deb-checkuid build-stamp
	rm -rf "$(DIR)"
	install -d -m0755 "$(DIR)"/var/service
	install -d -m0755 "$(DIR)"/sbin
	install -d -m0755 "$(DIR)"/usr/bin
	install -d -m0755 "$(DIR)"/usr/sbin
	for i in runit runit-init; do \
	  install -m0755 admin/runit/src/$$i "$(DIR)"/sbin/ || exit 1; \
	done
	for i in runsvdir runsv svlogd svwaitdown svwaitup runsvstat \
	  runsvctrl chpst; do \
	  install -m0755 admin/runit/src/$$i "$(DIR)"/usr/bin/ || exit 1; \
	done
	for i in runsvchdir utmpset; do \
	  install -m0755 admin/runit/src/$$i "$(DIR)"/usr/sbin/ || exit 1; \
	done
	install -m0755 admin/runit/src/utmpset "$(DIR)"/usr/sbin/
	$(STRIP) -R .comment -R .note "$(DIR)"/sbin/* "$(DIR)"/usr/sbin/* \
	  "$(DIR)"/usr/bin/*
	# runsvdir-start to be used from /etc/inittab
	install -m0755 debian/2 "$(DIR)"/usr/sbin/runsvdir-start
	# getty-5 service
	install -d -m0755 "$(DIR)"/etc/runit/getty-5
	install -m0755 admin/runit/etc/debian/getty-tty5/run \
	  "$(DIR)"/etc/runit/getty-5/run
	install -m0755 admin/runit/etc/debian/getty-tty5/finish \
	  "$(DIR)"/etc/runit/getty-5/finish
	# lintian overrides
	install -m0755 -d "$(DIR)"/usr/share/lintian/overrides
	install -m0644 debian/runit.lintian \
	  "$(DIR)"/usr/share/lintian/overrides/runit
	# man pages
	install -d -m0755 "$(DIR)"/usr/share/man/man8
	install -m0644 admin/runit/man/*.8 "$(DIR)"/usr/share/man/man8/
	install -m0644 debian/runsvdir-start.8 "$(DIR)"/usr/share/man/man8/
	gzip -9 "$(DIR)"/usr/share/man/man8/*.8
	# links
	install -d -m0755 "$(DIR)"/var/run/getty-5
	ln -s /var/run/getty-5 "$(DIR)"/etc/runit/getty-5/supervise
	# additional docs
	install -d -m0755 "$(DIR)"/usr/share/doc/runit/debian
	for i in 1 2 3 ctrlaltdel; do \
	  install -m0644 admin/runit/etc/debian/$$i \
	    "$(DIR)"/usr/share/doc/runit/debian/; \
	done
	# changelog
	rm -f changelog && ln -s admin/runit/package/CHANGES changelog

binary-indep:

binary-arch: install runit.deb
	test "$(CC)" != 'gcc' || \
	  dpkg-shlibdeps "$(DIR)"/usr/sbin/* "$(DIR)"/usr/bin/*
	dpkg-gencontrol -isp -prunit -P"$(DIR)"
	dpkg -b "$(DIR)" ..

binary: binary-indep binary-arch

.PHONY: build clean install binary-indep binary-arch binary

include debian/implicit
