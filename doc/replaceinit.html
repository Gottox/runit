<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html>
<head>
<title>runit - replacing init</title>
</head>
<body>
<a href="http://smarden.org/pape/">G. Pape</a><br>
<a href="index.html">runit</a>
<hr>
<h1>runit - replacing init</h1>
<hr>
Follow these steps to migrate from <i>sysvinit</i> to <i>runit</i> on
<a href="http://www.debian.org/releases/woody/">Debian GNU/Linux (woody)</a>.
The <tt>/sbin/init</tt> binary is not replaced until step 6, <i>runit</i> is
the default Unix process no 1 after step 7.
<p>
If you have installed the precompiled debian package, start at step 3.
<h3>Step 1: The three stages</h3>
<i>runit</i> looks for the three stages implementing the system's
<i>booting</i>, <i>running</i> and <i>shutdown</i> in <tt>/etc/runit/1</tt>,
<tt>/etc/runit/2</tt> and <tt>/etc/runit/3</tt>, create the files now:
<pre>
  # mkdir -p /etc/runit
  # cp -p /package/admin/runit/etc/debian/[123] /etc/runit/
</pre>
Create also a getty service directory:
<pre>
  # mkdir -p /etc/runit/getty-tty5
  # cp -p /package/admin/runit/etc/debian/getty-tty5/run /etc/runit/getty-tty5
</pre>
If you want <i>runit</i> to handle the ctrl-alt-del keyboard request, do:
<pre>
  # cp -p /package/admin/runit/etc/debian/ctrlaltdel /etc/runit/
</pre>
<h3>Step 2: The runit programs</h3>
The <i>runit</i> programs must reside on the root partition, copy them to
<tt>/sbin</tt>:
<pre>
  # cp -p /package/admin/runit/command/runit* /sbin/
</pre>
<h3>Step 3: The getties</h3>
At least one getty must run in stage 2 so you are able to login, choose a
free <tt>tty</tt>, say <tt>tty5</tt>, where <i>sysvinit</i> is not running
any getty (edit <tt>/etc/inittab</tt> and <tt>kill -HUP 1</tt> if
needed) and tell <a href="http://cr.yp.to/daemontools/svscan.html">svscan</a>
about the getty-tty5 <i>service</i>:
<pre>
  # ln -s /etc/runit/getty-tty5 /service/
</pre>
Check if the getty is running.
<h3>Step 4: Reboot into runit for testing</h3>
Boot your system with <i>runit</i> for the first time. This does not change
the default boot behavior of your system, <i>lilo</i> will be told to use
<i>runit</i> just once:
<ul>
  <li>reboot the system
  <li>enter the following on the lilo prompt:<br>
  <tt>init=/sbin/runit-init</tt>
  <li>watch the console output while <i>runit</i> boots up the system
  <li>switch to <tt>tty5</tt> when stage 2 is reached, a <tt>getty</tt>
  should run there, you are able to login.
</ul>
If you are not using <i>lilo</i> as boot loader, refer to the documentation
of your boot loader on how to pass <tt>init=/sbin/runit-init</tt> to the
kernel.
<h3>Step 5: Service migration</h3>
The goal is to migrate all services from <i>sysvinit</i> scheme to the
<a href="http://cr.yp.to/daemontools.html">daemontools</a> design. This
can be done smoothly. For those services that are not migrated to use
<tt>run</tt> scripts yet, add the corresponding <tt>init</tt>-script
startup to <tt>/etc/runit/1</tt>, e.g.:
<pre>
  #!/bin/sh
  # one time tasks
  rm -f /etc/runit/stopit
  /etc/init.d/rcS

  /etc/init.d/kerneld start
  /etc/init.d/rmnologin

  exit 0
</pre>
It is possible to just add <tt>/etc/init.d/rc 2</tt> for having all services
from the former runlevel 2 started as one time tasks, but keep the goal above
in mind, supervising services has great advantages.
<p>
Repeat step 4 and 5, using <tt><b>/sbin/runit-init 6</b></tt> to reboot the
system, until you are satisfied with your services startup. If anything goes
wrong, reboot the system into the default <i>sysvinit</i> <tt>/sbin/init</tt>
and repair the <i>runit</i> stages, then start again at step 4.
<h3>Step 6: Replace /sbin/init</h3>
Now it is time to replace the <i>sysvinit</i> <tt>/sbin/init</tt> binary:
<pre>
  # mv /sbin/init /sbin/init.sysv
  # ln -s runit-init /sbin/init
</pre>
<h3>Step 7: Final reboot</h3>
The last step is to do the final reboot to boot the system with the new
default Unix process no 1 <i>runit</i>.
<pre>
  # shutdown -r now
</pre>
To report success:
<pre>
  # ( uname -a ; cat /etc/runit/[123] ) | mail pape-runit-0.2.0@smarden.org
</pre>
<hr>
<address><a href="mailto:pape@smarden.org">
Gerrit Pape &lt;pape@smarden.org&gt;
</a></address>
<small>$Id$</small>
</body>
</html>
